<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--  Card list style  -->
    <style>
        .bullet {
            color: #FEC700;
        }

        .ok_import {
            color: #89DC9F !important;
            font-weight: bold;
        }

        .warn_msg {
            color: #FEC700 !important;
            font-weight: bold;
        }

        .ko_noimport {
            color: #FF977A !important;
            font-weight: bold;
        }

        .comment {
            font-style: italic
        }

        .deckname {
            background-color: #332200;
            color: #ffffff;
        }

        .section {
            font-weight: bold;
            background-color: #DDDDDD;
            color: #000000;
        }

        .cardtype {
            font-weight: bold;
            /*background-color: #FFCC66;*/
            color: #000000;
        }

        .cmc {
            font-weight: bold;
            /*background-color: #CCCCCC;*/
            color: #000000;
        }

        .rarity {
            font-weight: bold;
            background-color: #F1B27E;
            color: #000000;
        }

        .table-list {
            column-count: 2;
            height: 90%;
        }

        .form-control {
            display: block;
            width: 100%;
            line-height: 26px;
            margin-bottom: 15px;
            font-size: 14px;
            box-shadow: none;
            color: #333;
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 12px 18px;
            border-radius: 0;
            font-weight: 400;
            transition: all 500ms ease;
            -webkit-transition: all 500ms ease;
            -ms-transition: all 500ms ease;
            -o-transition: all 500ms ease;
        }

        .form-control:focus {
            border-color: #E91E63;
            outline: 0;
        }

    .section-padding {
        padding: 60px 0;
    }

    </style>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link href="//cdn.jsdelivr.net/npm/mana-font@latest/css/mana.css" rel="stylesheet"
          type="text/css"/>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2022.09.1/pyscript.css"/>
    <script defer src="https://pyscript.net/releases/2022.09.1/pyscript.js"></script>

    <py-config>
        autoclose_loader = true
        paths = ["./data.py", "./deck_parser.py"]

        [[runtimes]]
        src = "https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"
        name = "pyodide-0.21.3"
        lang = "python"
    </py-config>

</head>

<body>

<py-script>
        from deck_parser import DeckParser, Deck
        from js import document, console
        from pyodide.ffi import create_proxy
        from pyodide.http import pyfetch
        from data import ScryfallDB, SCRYFALL_DEFAULT_CARDS_URL
        import bz2
        import json

        CARDS_DB = None

        async def init_db(*args):
            global CARDS_DB
            if CARDS_DB is None:
                console.log("Cards DB INIT.")
                response = await pyfetch(SCRYFALL_DEFAULT_CARDS_URL, method="GET")
                bz_data = await response.memoryview()
                file = bz2.decompress(bz_data)
                json_data = json.loads(file)
                CARDS_DB = ScryfallDB(json_db=json_data)
                console.log("Cards DB INIT Completed.")
            return CARDS_DB

        async def parse_deck_list(grouping: str):
            cards_db = await init_db()
            deck_parser = DeckParser(cards_db=cards_db)
            card_list = document.getElementById("card_list_entry").value
            card_list = [l.strip() for l in card_list.split("\n")]
            tokens = deck_parser.parse_card_list(card_list)
            deck = Deck(tokens=tokens)
            display_tokens = deck.deck_list(grouping=grouping)
            if display_tokens:
                rows = ""
                for token in display_tokens:
                    rows += token.to_html

                document.getElementById("card_list_parsed").innerHTML = rows
                document.getElementById("card_list_parsed").style.display = "table"
                document.getElementById("instructions").style.display = "none"

                if not deck.is_valid:
                    errors, warnings = deck.validate()
                    error_list = ""
                    for error in errors:
                        error_list += error.to_html()
                    for warning in warnings:
                        error_list += warning.to_html()
                    document.getElementById("messages").innerHTML = error_list
                    document.getElementById("col-messages").style.display = "inline"
                    document.getElementById("form-submit").disabled = True
                else:  # Deck IS VALID
                    success_badge = '&lt;p&gt;&lt;span class="badge badge-success"&gt;Success: &lt;/span&gt; Deck is valid! &lt;/p&gt;'
                    msg = ""
                    _, warnings = deck.validate()
                    if len(warnings):
                        warning_list = ""
                        for warning in warnings:
                            warning_list += warning.to_html()
                        msg += warning_list
                    msg += success_badge
                    document.getElementById("form-submit").disabled = False
                    document.getElementById("messages").innerHTML = msg

                    # Get list ready for posting
                    document.getElementById("id_maindeck_cards").value = deck.mainboard_to_json()
                    document.getElementById("id_sideboard_cards").value = deck.sideboard_to_json()
                    document.getElementById("id_deck_list").value = deck.decklist_mtgo_export()

            else:
                document.getElementById("card_list_parsed").innerHTML = ""
                document.getElementById("col-messages").style.display = "none"
                document.getElementById("card_list_parsed").style.display = "none"
                document.getElementById("instructions").style.display = "block"

        @create_proxy
        async def parse_deck_no_group(*args, **kwargs):
            await parse_deck_list(grouping=Deck.NOGROUP)

        @create_proxy
        async def parse_deck_group_colour(*args, **kwargs):
            await parse_deck_list(grouping=Deck.COLOUR)

        @create_proxy
        async def parse_deck_group_rarity(*args, **kwargs):
            await parse_deck_list(grouping=Deck.RARITY)

        @create_proxy
        async def parse_deck_group_cmc(*args, **kwargs):
            await parse_deck_list(grouping=Deck.CMC)

        @create_proxy
        async def parse_deck_group_type(*args, **kwargs):
            await parse_deck_list(grouping=Deck.SPELL)

        @create_proxy
        async def parse_deck_group_type_extended(*args, **kwargs):
            return parse_deck_list(grouping=Deck.TYPE)

        init_cards_db = create_proxy(init_db)

        document.getElementById("card_list_entry").addEventListener("focus", init_cards_db)
        document.getElementById("card_list_entry").addEventListener("keypress", parse_deck_no_group)
        document.getElementById("card_list_entry").addEventListener("change", parse_deck_no_group)

        # Deck Organiser Buttons
        document.getElementById("nogroup").addEventListener("click", parse_deck_no_group)
        document.getElementById("color").addEventListener("click", parse_deck_group_colour)
        document.getElementById("rarity").addEventListener("click", parse_deck_group_rarity)
        document.getElementById("cmc").addEventListener("click", parse_deck_group_cmc)
        document.getElementById("spell").addEventListener("click", parse_deck_group_type)
        document.getElementById("card_type").addEventListener("click",
                                                              parse_deck_group_type_extended)
</py-script>
<section class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col">
                <h3>M:TG Premodern Deck list Validator</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-12">
                <div class="row justify-content">
                    <div class="col-xl-4">
                        <h4><span class="badge badge-info">Card List</span></h4>
                        <textarea id="card_list_entry" class="form-control"
                                  rows="20" cols="35"
                                  style="width: 100%"></textarea>
                    </div>
                    <div class="col-xl-8">
                        <div class="btn-group btn-group-toggle" data-toggle="buttons">
                            <a href="#" class="btn btn-secondary btn-lg" role="button"
                               aria-pressed="true"
                               id="nogroup">No Group</a>
                            <a href="#" class="btn btn-secondary btn-lg" role="button"
                               aria-pressed="true"
                               id="color">Colour</a>
                            <a href="#" class="btn btn-secondary btn-lg" role="button"
                               aria-pressed="true"
                               id="rarity">Rarity</a>
                            <a href="#" class="btn btn-secondary btn-lg" role="button"
                               aria-pressed="true"
                               id="cmc">CMC</a>
                            <a href="#" class="btn btn-secondary btn-lg" role="button"
                               aria-pressed="true"
                               id="spell">Spell</a>
                            <a href="#" class="btn btn-secondary btn-lg" role="button"
                               aria-pressed="true"
                               id="card_type">Card Type</a>
                        </div>
                        <div class="table-list" style="margin-top: 10px;">
                            <div id="instructions">
                                <h5>Quick Instructions</h5>
                                <div>
                                    <p>To start loading your deck list just type
                                        the names of the cards you want in the Card List
                                        (one per line).
                                        Alternatively, (fastest way) we recommend
                                        copying & pasting your decklist in one of the
                                        most common <b>deck formats</b>,
                                        and hit <b>Enter</b> to trigger the automatic
                                        parsing.
                                    </p>
                                    <p>
                                        MTG Arena; MTGO; XMage; MTG Goldfish (all export); TappedOut
                                        (all export, but CSV); DeckStats.net; ".dec" files are
                                        all <b>supported formats</b>.
                                    </p>
                                    <p>
                                        All identified cards will automatically appear in a summary
                                        deck
                                        list table
                                        (and these instructions will disappear!).
                                        <br>
                                        The table can be quickly re-organised using the
                                        <b>buttons</b>
                                        above
                                        to quickly gather statistics and double-check your list.
                                    </p>
                                    <h5>Important and Quick tips</h5>
                                    <p><b>(!!!)</b> Sometimes it may happen that not all scripts are
                                        correctly loading (working on that!)
                                        If you notice an error appearing right above this section,
                                        and
                                        nothing happens when
                                        writing in the card list, please <b>refresh</b> this page
                                        until
                                        it works!!
                                        (Apologies for any inconvenience))!</p>
                                    <p><b>(1.)</b> Prepend to each card line the number of copies to
                                        import
                                        (default: 1). (e.g. <code>"4 Giant Growth"</code> or <code>"4x
                                            Giant
                                            Growth"</code>);
                                    </p>
                                    <p><b>(2.)</b> Include the code of an M:TG set before or after
                                        the
                                        card name to select a specific card art (using either
                                        Scryfall
                                        or MTGO set codes).
                                        <b>NOTE: </b> Only Premodern legal cards are supported.
                                        Therefore non-legal cards
                                        will simply be NOT RECOGNISED.
                                    </p>
                                    <p><b>(3.)</b> Lines starting with <code>#</code> or
                                        <code>//</code>
                                        will
                                        be
                                        interpreted as comments, and so skipped in the deck list
                                        parsing.</p>

                                </div>
                            </div>
                            <table style="width: 100%" class="table table-sm table-responsive-sm"
                                   style="display: none">
                                <tbody id="card_list_parsed"></tbody>
                            </table>
                        </div>
                        <div class="col" id="col-messages" style="display: inline">
                            <div id="messages" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <input type="hidden" name="maindeck_cards" class="form-control"
                               id="id_maindeck_cards">
                    </div>
                    <div class="col-md-12">
                        <input type="hidden" name="sideboard_cards" class="form-control"
                               id="id_sideboard_cards">
                    </div>
                    <div class="col-md-12">
                        <input type="hidden" name="deck_list" class="form-control"
                               id="id_deck_list">
                    </div>
                </div>
            </div>

        </div>
    </div></section>


</body>

</html>
